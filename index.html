<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>桃園YouBike站點地圖</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #050b1e;
}

/* ===== 上方深色官方風 ===== */
#topbar {
  background: radial-gradient(1200px 300px at 20% -50%, #1b2a4a, #050b1e);
  color: #fff;
  padding: 20px 24px 16px;
}

#topbar h1 {
  margin:Consumption 0 14px;
  font-size: 22px;
  font-weight: 700;
}

.toolbar {
  display: grid;
  grid-template-columns: 1.6fr 1fr 1fr 1.2fr;
  gap: 12px;
}

.toolbar input,
.toolbar select {
  background: rgba(255,255,255,.08);
  color: #fff;
  border: 1px solid rgba(255,255,255,.15);
  padding: 12px 14px;
  border-radius: 14px;
  font-size: 15px;
  outline: none;
}

.toolbar input::placeholder {
  color: rgba(255,255,255,.55);
}

.toolbar select option {
  color: #000;
}

.meta {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-top: 14px;
  font-size: 14px;
  color: rgba(255,255,255,.75);
}

.meta button {
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 999px;
  cursor: pointer;
}

/* ===== 地圖 ===== */
#map {
  height: calc(100vh - 190px);
  width: 100%;
}

/* ===== marker 顏色（完全對齊你提供的圖） ===== */
.marker.green  {
  --fill: #2DBE60;
  --stroke: #1E7F42;
}
.marker.yellow {
  --fill: #F2A31B;
  --stroke: #B87400;
}
.marker.red    {
  --fill: #E64545;
  --stroke: #9E2A2A;
}

.leaflet-div-icon {
  background: transparent !important;
  border: none !important;
}

.marker svg {
  width: 56px;
  height: 56px;
}

.leaflet-top.leaflet-left {
  right: 12px;
  left: auto;
}

.user-dot {
  width: 18px;
  height: 18px;
  background: #1A73E8;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 0 10px rgba(0,0,0,.45);
}
</style>
</head>

<body>

<header id="topbar">
  <h1>桃園YouBike 2.0｜場站地圖</h1>

  <div class="toolbar">
    <input id="search" placeholder="搜尋場站名稱 / 地址…" />

    <select id="city">
      <option value="all">縣市</option>
      <option value="ty">桃園</option>
    </select>

    <select id="statusFilter">
      <option value="all">場站狀態</option>
      <option value="green">正常</option>
      <option value="yellow">無車</option>
      <option value="red">無位</option>
    </select>

    <select id="interval">
      <option value="30">每 30 秒自動更新</option>
      <option value="60">每 60 秒自動更新</option>
      <option value="0">停止自動更新</option>
    </select>
  </div>

  <div class="meta">
    <span id="lastUpdate">最後更新：--</span>
    <span id="count">筆數：--</span>
  </div>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const TAOYUAN_API = "stations.json";

const map = L.map("map").setView([25.03, 121.55], 11);
map.zoomControl.setPosition("topright");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

let markers = [];
let dataTY = [];
let timer = null;

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    L.marker([pos.coords.latitude, pos.coords.longitude], {
      icon: L.divIcon({
        className: "",
        iconSize: [24, 24],
        html: `<div class="user-dot"></div>`
      })
    }).addTo(map);
  });
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function getStatus(b, r) {
  if (r === 0) return "red";
  if (b === 0) return "yellow";
  return "green";
}

/* ===== 圓形 marker（數字＋橫線完全保留） ===== */
function makeMarkerHTML(b, r, status) {
  return `
    <div class="marker ${status}">
      <svg viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="28"
          fill="var(--fill)"
          stroke="var(--stroke)"
          stroke-width="4"/>
        <line x1="18" y1="32" x2="46" y2="32"
          stroke="#000"
          stroke-width="2"/>
        <text x="32" y="26" text-anchor="middle"
          font-size="18" font-weight="700" fill="#000">${b}</text>
        <text x="32" y="50" text-anchor="middle"
          font-size="18" font-weight="700" fill="#000">${r}</text>
      </svg>
    </div>`;
}

function render() {
  clearMarkers();

  const kw = search.value.trim();
  const statusF = statusFilter.value;

  dataTY
    .filter(s => {
      const st = getStatus(s.borrow, s.ret);
      if (statusF !== "all" && st !== statusF) return false;
      if (kw && !s.name.includes(kw) && !s.addr.includes(kw)) return false;
      return true;
    })
    .forEach(s => {
      const marker = L.marker([s.lat, s.lng], {
        icon: L.divIcon({
          iconSize: [56, 56],
          iconAnchor: [28, 28],
          html: makeMarkerHTML(s.borrow, s.ret, getStatus(s.borrow, s.ret))
        })
      }).addTo(map);

      markers.push(marker);
    });

  count.textContent = `筆數：${markers.length}`;
}

function loadData() {
  fetch(TAOYUAN_API)
    .then(r => r.json())
    .then(ty => {
      dataTY = Object.values(ty.retVal).map(s => ({
        name: s.sna,
        addr: s.ar || "",
        lat: +s.lat,
        lng: +s.lng,
        borrow: +s.sbi,
        ret: +s.bemp
      }));
      lastUpdate.textContent = "最後更新：" + new Date().toLocaleString();
      render();
    });
}

loadData();
timer = setInterval(loadData, 30000);

interval.addEventListener("change", e => {
  clearInterval(timer);
  const sec = Number(e.target.value);
  if (sec > 0) timer = setInterval(loadData, sec * 1000);
});

refresh.addEventListener("click", loadData);
search.addEventListener("input", render);
statusFilter.addEventListener("change", render);
city.addEventListener("change", render);
</script>

</body>
</html>





